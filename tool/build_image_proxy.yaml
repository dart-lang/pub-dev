# Configuration for Google Cloud Build
#
# Triggers in the project kicks off a cloud build task based on the
# configuration in this file. Permissions granted to this task is configured
# by granting permissions to the service account:
#   <project-id>@cloudbuild.gserviceaccount.com
#
# Reference: https://cloud.google.com/cloud-build/docs/build-config
# https://docs.cloud.google.com/build/docs/deploying-builds/deploy-cloud-run
steps:
  - name: 'gcr.io/cloud-builders/docker'
    script: |
      #!/usr/bin/env bash
      set -x
      if [[ "$PROJECT_ID" != dartlang-pub  && "$PROJECT_ID" != dartlang-pub-dev ]]; then
        echo 'Only deploy from the dartlang-pub project'
        exit 1;
      fi
      if [[ ! "$TAG_NAME" =~ ^image-proxy-.*$ ]]; then
        echo 'This script is only intended for use on image_proxy-<version> tags'
        echo 'Current tag': $TAG_NAME
        exit 1;
      fi
      docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/image-proxy/image-proxy:$TAG_NAME . --file pkg/image_proxy/Dockerfile
      docker push us-central1-docker.pkg.dev/$PROJECT_ID/image-proxy/image-proxy:$TAG_NAME
    env:
      - 'PROJECT_ID=$PROJECT_ID'
      - 'BRANCH_NAME=$BRANCH_NAME'
      - 'TAG_NAME=$TAG_NAME'
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    # Deploy latest version to Cloud Run. Depends on an existing version having
    # been configured in terraform. The terraform configuration should ignore
    # changes to:
    # - image URL
    #
    # It should set up and manage:
    # - HMAC_KEY_ID environment variable
    # - service account with permissions to access the secret manager.
    # - appropriate CPU/Memory settings. And this new deployment will inherit
    #   those settings.
    #
    # Be careful when changing this script, as modifying non-ignored settings
    # will cause inconsistency in the terraform state.
    script: |
      #!/usr/bin/env bash
      set -x
      gcloud run deploy image_proxy_server \
        --image="us-central1-docker.pkg.dev/$PROJECT_ID/image-proxy/image-proxy:$TAG_NAME" \
    env:
      - 'PROJECT_ID=$PROJECT_ID'
      - 'TAG_NAME=$TAG_NAME'
timeout: '5400s'
